# 🩺 텔레그램 봇 진단 및 해결 보고서

**날짜**: 2026-02-09
**작업 내용**: 리플릿(Replit) 환경에서의 봇 작동 중단 원인 분석 및 코드 수정

---

## 1. 🔍 원인 분석 (테스트 결과)

로컬 환경에서 진행한 모듈별 연결 테스트 결과, **모든 API 자격 증명은 정상**임이 확인되었습니다.

| 테스트 항목 | 결과 | 비고 |
|:---:|:---:|:---|
| **Telegram API** | ✅ 성공 | 봇 연결 및 정보 가져오기 성공 |
| **Notion API** | ✅ 성공 | 데이터베이스 접근 및 쓰기 권한 정상 |
| **Claude API** | ✅ 성공 | AI 모델 호출 및 응답 파싱 정상 |

### 🚨 추정되는 문제 원인 (Replit 환경 특이성)

1.  **프로세스 잠금(Lock File) 충돌**:
    *   기존 로직은 `.bot.lock` 파일이 있고 생성된 지 5분 미만이면 봇 실행을 차단했습니다.
    *   Replit이 'Sleep Mode'로 전환되었다가 UptimeRobot에 의해 다시 깨어날 때, 이전 프로세스가 비정상 종료되어 잠금 파일이 남아있으면 **봇이 실행되지 않고 즉시 종료**되었을 가능성이 높습니다.
    *   이 경우 웹 서버도 켜지지 않거나, 좀비 프로세스처럼 남아있어 메시지를 처리하지 못하게 됩니다.

2.  **상태 모니터링 부재**:
    *   기존의 `Get /` 엔드포인트는 단순히 "웹 서버가 켜져 있음"만 알려주었습니다.
    *   봇이 실제로 텔레그램과 연결되어 있는지(`Polling`), 오류가 발생했는지 알 수 없었습니다.

---

## 2. 🛠️ 수정 및 개선 사항

`bot.js` 파일에 다음 기능들을 추가하여 안정성을 대폭 강화했습니다.

### 1) 스마트 잠금 파일 관리 (Lock File improvements)
*   단순히 파일 시간만 확인하는 것이 아니라, **해당 PID가 실제로 실행 중인지 프로세스를 확인**합니다.
*   죽은 프로세스의 잠금 파일이라면 자동으로 삭제하고 봇을 정상 실행합니다.

### 2) 상세 상태 모니터링 (`/status`)
*   웹 브라우저에서 `https://<당신의-리플릿-주소>/status` 로 접속하면 봇의 상세 상태를 볼 수 있습니다.
*   **확인 가능한 정보**:
    *   마지막 텔레그램 수신 시각
    *   Notion 저장 성공/실패 횟수
    *   현재 Polling(메시지 수신) 상태 여부
    *   마지막 발생한 오류 내용

### 3) Replit 내 진단 스크립트 추가
*   `diagnosis/full_check.js` 파일을 추가했습니다. Replit 콘솔에서 실행하여 환경을 점검할 수 있습니다.

---

## 3. 🚀 다음 단계 (사용자 가이드)

### Step 1. Replit에 코드 업데이트
현재 수정된 `bot.js`와 `diagnosis/full_check.js`를 Replit 프로젝트에 반영하세요. (Git Push 또는 파일 복사)

### Step 2. 진단 스크립트 실행 (Replit Console)
Replit의 Shell 또는 Console에서 다음 명령어를 입력하여 환경이 정상인지 확인합니다.
```bash
node diagnosis/full_check.js
```

### Step 3. 봇 상태 확인
텔레그램 봇이 메시지를 읽지 않는다면, 브라우저에서 다음 주소로 접속해 상태를 확인하세요.
`https://<당신의-리플릿-URL>/status`

*   `isPolling: false`라면 재시작이 필요합니다.
*   `failedSaves`가 증가한다면 Notion 설정 문제입니다.
*   `uptime`이 자주 초기화된다면 Replit이 자주 재시작되는 것입니다.
